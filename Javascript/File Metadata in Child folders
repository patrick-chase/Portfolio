/** Notes
 * This work flow was informed by: 
 *    https://gist.github.com/mesgarpour/07317e81e9ee2b3f1699 
 *    https://developers.google.com/apps-script/reference/drive/folder-iterator
 *    https://stackoverflow.com/questions/40607752/google-apps-script-exception-cannot-retrieve-the-next-object-iterator-has-reac 
 *    https://stackoverflow.com/questions/45689629/how-to-use-continuationtoken-with-recursive-folder-iterator
 *    
 */;





function onOpen() {
  var SS = SpreadsheetApp.getActiveSpreadsheet();
  var ui = SpreadsheetApp.getUi();
  ui.createMenu('List Files/Folders')
    .addItem('List All Files and Folders', 'listFilesAndFolders')
    .addToUi();
};

//march month folder ids, need to be updated every month.
monthFolder = ["1vDDuIo-gl4CJhNPDG3Fo3R0rGBpWTieo",// cnx_aibmaffendy
              "1AuhE4LcEhvEaoEt5iuJqagOLvKVc4Tl_", // cnx_hvijayakumar
              "1Et-3X2Tddl0kg9DBfmZnhyEM2GZMhM7G", // cnx_mhabdullah
              "1H2o3mpM2i7bLO_NdnKQ_fsZRKE25ZGmr", // cnx_nursyafiqua
              "1WzLUkwpVvj0MvKanCLCkf-fMDMwCAUkN", // cnx_pksandaran
]; 

//Agent ldaps for each tab in google sheet. 
pageName = ["cnx_aibmaffendy",
            "cnx_hvijayakumar",
            "cnx_mhabdullah",
            "cnx_nursyafiqua",
            "cnx_pksandaran"
];

// Setting a max run time to break for loop
var MAX_RUNNING_TIME_MS = 1000 * 60 * 60 * 24*7; // run time for each loop is 10 minutes
var startTime = (new Date()).getTime();  

    function listFilesAndFolders(){
      for(z=0; z<monthFolder.length; z++){
      // var folderId = Browser.inputBox('Enter folder ID', Browser.Buttons.OK_CANCEL);
      var today = new Date();
      var folderId = monthFolder[z]
      if (folderId === "") {
        Browser.msgBox('Folder ID is invalid');
        return;
      }
      getFolderTree(folderId, true); 
    };
  };  

    // Get Folder Tree
    function getFolderTree(folderId, listAll) {
      try {
        // Get folder by id
        var parentFolder = DriveApp.getFolderById(folderId);
        
        // Initialise the sheet
        var file, data, sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName(pageName[z]);
        // sheet.clear();
        sheet.appendRow(["Full Path", "Name","Type" ,"Date Created", "URL", "Last Updated", "Owner Email"]);
        
        // Get files and folders
        getChildFolders(parentFolder.getName(), parentFolder, data, sheet, listAll);
      } catch (e) {
        Logger.log(e.toString());
      }
    };

    // Get the list of files and folders and their metadata in recursive mode
    function getChildFolders(parentName, parent, data, sheet, listAll) {
      var childFolders = parent.getFolders();
      var today = new Date();
    
      // List folders inside the folder
      while (childFolders.hasNext()) {
        var childFolder = childFolders.next();
        var currTime = (today.getTime()); 
        var elapsedTimeInMS = currTime - startTime;
        var timeLimitExceeded = elapsedTimeInMS >= MAX_RUNNING_TIME_MS;
        // this conditional sets the time frame to the previous days. the last number(5) is the total number of days you're pull data for.  
        if(childFolder.getLastUpdated() >= (today - (1000 * 60 * 60 * 24*5))){
          var folderId = childFolder.getId();

          data = [ 
            parentName + "/" + childFolder.getName(),
            childFolder.getName(),
            "Folder",
            childFolder.getDateCreated(),
            childFolder.getUrl(),
            childFolder.getLastUpdated(),
            childFolder.getOwner().getEmail()
          ];
          // Write to sheet
          sheet.appendRow(data)
          };

        // List files inside the folder
        var files = childFolder.getFiles();

          while (listAll & files.hasNext()) {
            var childFile = files.next();
            
            // past 5 days of files only
            if(childFile.getLastUpdated() >= (today - (1000 * 60 * 60 * 24*5))){
              data = [ 
                parentName + "/" + childFolder.getName() + "/" + childFile.getName(),
                childFile.getName(),
                "Files",
                childFile.getDateCreated(),
                childFile.getUrl(),
                childFile.getLastUpdated(),
                childFile.getOwner().getEmail(),
              ];
              // Write
              sheet.appendRow(data)
            }
        }
        // Recursive call of the subfolder
        getChildFolders(parentName + "/" + childFolder.getName(), childFolder, data, sheet, listAll);  

      // break for loop to move on to next agent's folder 
        if(timeLimitExceeded){break};
        //Utilities.sleep(1500)
      }
    };
